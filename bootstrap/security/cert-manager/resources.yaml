---
resources:
  # Production tls certificates
  - apiVersion: cert-manager.io/v1
    kind: ClusterIssuer
    metadata:
      name: letsencrypt-production
      labels:
        app.kubernetes.io/name: cert-manager-reources
      annotations:
        meta.helm.sh/release-name: cert-manager-reources
        meta.helm.sh/release-namespace: security
    spec:
      acme:
        server: https://acme-v02.api.letsencrypt.org/directory
        email: gary@theclarkhome.com
        privateKeySecretRef:
          name: letsencrypt-production
        solvers:
          - dns01:
              cloudflare:
                email: gary@theclarkhome.com
                apiTokenSecretRef:
                  name: cloudflare-cert-manager-token
                  key: tunnelToken
            selector:
              dnsZones:
                - "theclarkhome.com"

  - apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: theclarkhome-com
      namespace: kube-system
      labels:
        app.kubernetes.io/name: cert-manager-reources
      annotations:
        meta.helm.sh/release-name: cert-manager-reources
        meta.helm.sh/release-namespace: security
    spec:
      secretName: theclarkhome-com-tls
      issuerRef:
        name: letsencrypt-production
        kind: ClusterIssuer
      commonName: "*.theclarkhome.com"
      dnsNames:
        - "theclarkhome.com"
        - "*.theclarkhome.com"


  # Self signed certficates
  - apiVersion: cert-manager.io/v1
    kind: ClusterIssuer
    metadata:
      name: cluster-selfsigned-issuer
      labels:
        app.kubernetes.io/name: cert-manager-reources
      annotations:
        meta.helm.sh/release-name: cert-manager-reources
        meta.helm.sh/release-namespace: security
    spec:
      selfSigned: {}

  - apiVersion: cert-manager.io/v1
    kind: ClusterIssuer
    metadata:
      name: cluster-signed-issuer
      labels:
        app.kubernetes.io/name: cert-manager-reources
      annotations:
        meta.helm.sh/release-name: cert-manager-reources
        meta.helm.sh/release-namespace: security
    spec:
      ca:
        secretName: cluster-signed-issuer-secret

  - apiVersion: cert-manager.io/v1
    kind: Certificate
    metadata:
      name: &name cluster-signed-issuer
      labels:
        app.kubernetes.io/name: cert-manager-reources
      annotations:
        meta.helm.sh/release-name: cert-manager-reources
        meta.helm.sh/release-namespace: security
    spec:
      isCA: true
      commonName: *name
      subject:
        organizations:
          - theclarkhome.com
      secretName: cluster-signed-issuer-secret
      privateKey:
        algorithm: ECDSA
        size: 256
      issuerRef:
        name: cluster-selfsigned-issuer
        kind: ClusterIssuer
        group: cert-manager.io
