---
resources:
  bitwarden-bootstrap-issuer:
    apiVersion: cert-manager.io/v1
    kind: ClusterIssuer
    spec:
      selfSigned: {}

  bitwarden-bootstrap-certificate:
    apiVersion: cert-manager.io/v1
    kind: Certificate
    spec:
      # this is discouraged but required by ios
      # commonName: cert-manager-bitwarden-tls
      isCA: true
      secretName: "{{.Release.Name}}-bitwarden-tls-certs"
      subject:
        organizations:
          - external-secrets.io
      dnsNames:
        - bitwarden-sdk-server.default.svc.cluster.local
        - localhost
      ipAddresses:
        - 127.0.0.1
        - ::1
      privateKey:
        algorithm: RSA
        encoding: PKCS8
        size: 2048
      issuerRef:
        name: "{{.Release.Name}}-bitwarden-bootstrap-issuer"
        kind: ClusterIssuer
        group: cert-manager.io

  bitwarden-certificate-issuer:
    apiVersion: cert-manager.io/v1
    kind: ClusterIssuer
    spec:
      ca:
        secretName: bitwarden-tls-certs

  &tls bitwarden-tls-certs:
    apiVersion: cert-manager.io/v1
    kind: Certificate
    forceRename: *tls
    spec:
      secretName: *tls
      isCA: true
      dnsNames:
        - bitwarden-sdk-server.security.svc.cluster.local
        - localhost
      ipAddresses:
        - 127.0.0.1
        - ::1
      privateKey:
        algorithm: RSA
        encoding: PKCS8
        size: 2048
        rotationPolicy: Always
      issuerRef:
        name: "{{.Release.Name}}-bitwarden-certificate-issuer"
        kind: ClusterIssuer

  &css bitwarden-css-certs:
    apiVersion: cert-manager.io/v1
    kind: Certificate
    forceRename: *css
    spec:
      secretName: *css
      dnsNames:
        - bitwarden-sdk-server.security.svc.cluster.local
        - localhost
      privateKey:
        algorithm: RSA
        encoding: PKCS8
        size: 2048
        rotationPolicy: Always
      issuerRef:
        name: "{{.Release.Name}}-bitwarden-certificate-issuer"
        kind: ClusterIssuer
        group: cert-manager.io
