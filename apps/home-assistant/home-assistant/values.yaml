---

# hostname to use for ingress
global:
  host: hass

defaultPodOptions:
  automountServiceAccountToken: false
  securityContext:
    runAsUser: 0
#    runAsGroup: 0
#    fsGroup: 0

controllers:
  home-assistant:
    annotations:
      secret.reloader.stakater.com/reload: <-
        {{.Release.Name}}-secret,
        {{.Release.Name}}-github,
        {{.Release.Name}}-prometheus

    pod:
      annotations:
        k8s.v1.cni.cncf.io/networks: |
          [{
            "name":"macvlan-static",
            "namespace": "network",
            "ips": ["10.58.0.210"]
          }]

    initContainers:
      kopiaignore:
        image:
          repository: docker.io/library/alpine
          tag: 3.22@sha256:4b7ce07002c69e8f3d704a9c5d6fd3053be500b7f1c69fc0d80990c2ad8dd412
        command: ["/bin/sh", "-c"]
        # TODO better handling for database backup
        args:
          - |-
            tee /config/.kopiaignore <<!
            /.code-server/logs
            /.git
            /.venv
            !
        securityContext:
          runAsUser: 0
      github-setup:
        # Connect to config repo
        image:
          repository: docker.io/library/ubuntu
          tag: 24.04@sha256:66460d557b25769b102175144d538d88219c077c678a49af4afca6fbfc1b5252
        command: ["/bin/sh", "-c"]
        args:
          - |-
            set -x
            cd /config
            # Need to initialise repository?
            if [ ! -d .git ] ; then
              # This container will never have git installed
              apt update && apt install -y git
              # Prepare to clone
              mkdir temp-dir
              git clone https://github.com/mergwyn/home-assistant-config temp-dir
              mv temp-dir/.git .
              rm -rf temp-dir
              # Finally get files
              git checkout .
            fi
        securityContext:
          runAsUser: 0

    containers:
      app:
        image:
          repository: ghcr.io/home-assistant/home-assistant
          tag: "2025.10.4@sha256:449140e073d8d7814098cd62dfdbb326ad043f51a3c4d4721889369f46751d52"
        env:
          TZ: Europe/London
          VENV_FOLDER: /venv
        resources:
          requests:
            cpu: 47m
            memory: 1167M
          limits:
            memory: 2077M

#      code-server:
#        image:
#          repository: ghcr.io/coder/code-server
#          tag: 4.105.1
#        args:
#          - --auth
#          - none
#          - --disable-telemetry
#          - --disable-update-check
#          - --user-data-dir
#          - /config/.code-server
#          - --extensions-dir
#          - /config/.code-server
#          # - --install-extension
#          # - trunk.io
#          - --port
#          - "12321"
#          - /config
#        env:
#          TZ: Europe/London
#          HASS_SERVER: http://localhost:8123
#        envFrom:
#          - secretRef:
#              name: "{{.Release.Name}}-github"
#        resources:
#          requests:
#            cpu: 10m
#          limits:
#            memory: 2Gi

service:
  app:
    forceRename: "{{.Release.Name}}"
    ports:
      http:
        port: &http-port 8123
#  code-server:
#    ports:
#      http:
#        port: &code-server-port 12321

serviceMonitor:
  app:
    enabled: true
    serviceName: "{{.Release.Name}}"
    endpoints:
      - port: http
        scheme: http
        interval: 1m
        scrapeTimeout: 30s
        path: /api/prometheus
        bearerTokenSecret:
          name: home-assistant-prometheus
          key: token

persistence:
  config:
    type: persistentVolumeClaim
    storageClass: openebs-zfspv
    accessMode: ReadWriteOnce
    retain: true
    size: 10Gi
    globalMounts:
      - path: /config
  backups:
    enabled: true
    type: nfs
    server: 10.58.0.12
    path: /srv/backup/home-assistant
    globalMounts:
      - path: /config/backups
  cache:
    type: persistentVolumeClaim
    storageClass: openebs-zfspv
    accessMode: ReadWriteOnce
    retain: true
    size: 1Gi
    advancedMounts:
      home-assistant:
        app:
          - path: /config/.venv
            subPath: hass-venv
  secrets:
    type: secret
    name: "{{.Release.Name}}-secret"
    advancedMounts:
      home-assistant:
        app:
          - path: /config/secrets.yaml
            subPath: secrets.yaml
            readOnly: true
#  tmpfs:
#    type: emptyDir
#    advancedMounts:
#      home-assistant:
#        app:
#          - path: /tmp
#            subPath: hass-tmp
#        code-server:
#          - path: /tmp
#            subPath: code-server-tmp
#          - path: /nonexistent
#            subPath: nonexistent

ingress:
  external:
    enabled: true
    className: cloudflare-tunnel
    annotations:
      cloudflare-tunnel-ingress-controller.strrl.dev/backend-protocol: http
    hosts:
      - host: "{{.Values.global.host}}.{{.Values.global.domain}}"
        paths:
          - path: /
            pathType: Prefix
            service:
              identifier: app
              port: http
    tls:
      - hosts:
          - "*.{{.Values.global.domain}}"

rawResources:
  middleware:
    apiVersion: traefik.io/v1alpha1
    kind: Middleware
    spec:
      spec:
        stripPrefixRegex:
          regex:
            - "^/code/"

  ingress:
    enabled: true
    kind: IngressRoute
    apiVersion: traefik.io/v1alpha1
    annotations:
      kubernetes.io/ingress.class: traefik-external
    spec:
      spec:
        entryPoints:
          - websecure
        routes:
          - kind: Rule
            # yamllint disable-line rule:line-length
            match: Host(`{{.Values.global.host}}.{{.Values.global.domain}}`) && PathPrefix(`/`)
            priority: 10
            services:
              - name: "{{.Release.Name}}"
                port: *http-port
#          - kind: Rule
#            # yamllint disable-line rule:line-length
#            match: Host(`{{.Values.global.host}}.{{.Values.global.domain}}`) && PathRegexp(`^/code/.*`)
#            priority: 11
#            services:
#              - name: "{{.Release.Name}}-code-server"
#                port: *code-server-port
#            middlewares:
#              - name: "{{.Release.Name}}-middleware"
        tls: {}

  rule:
    kind: PrometheusRule
    apiVersion: monitoring.coreos.com/v1
    spec:
      spec:
        groups:
          - name: home-assistant
            rules:
              - alert: HomeAssistantAbsent
                annotations:
                  description: |
                    Home Assistant has disappeared from
                    Prometheus service discovery.
                  summary: Home Assistant is down.
                expr: |
                  absent(up{job=~".*home-assistant.*"} == 1)
                for: 5m
                labels:
                  severity: critical
