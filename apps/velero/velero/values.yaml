---

annotations:
  secret.reloader.stakater.com/reload: <-
    minio-s3-conf,
    idrivee2-s3-conf,
    rustfs-s3-config
  configmap.reloader.stakater.com/reload: <-
    velero-backup-repository-config

defaultBackupStorageLocation: rustfs
snapshotsEnabled: false
#Â defaultVolumeSnapshotLocations: [minio, rustfs, idrive, default]

kubectl:
  image:
    repository: public.ecr.aws/bitnami/kubectl
    tag: latest@sha256:738649b2b4b12756b3b46561e393a7c5006e5b24f26b5ee0cd544cafec709a2a

configuration:
  uploaderType: kopia
  # defaultVolumesToFsBackup: true
  defaultSnapshotMoveData: true
  features: EnableCSI

  backupStorageLocation:
    - name: minio
      provider: aws
      bucket: velero
      credential:
        name: minio-s3-conf
        key: cloud
      config:
        region: Northallerton
        s3ForcePathStyle: true
        s3Url: http://foxtrot.theclarkhome.com:9000
        publicUrl: http://foxtrot.theclarkhome.com:9000

    - name: default
      provider: aws
      bucket: velero
      credential:
        name: minio-s3-conf
        key: cloud
      config:
        region: Northallerton
        s3ForcePathStyle: true
        s3Url: http://foxtrot.theclarkhome.com:9000
        publicUrl: http://foxtrot.theclarkhome.com:9000

    - name: rustfs
      provider: aws
      bucket: velero
      default: true
      credential:
        name: rustfs-s3-conf
        key: cloud
      config:
        region: rustfs-Northallerton
        s3ForcePathStyle: true
        s3Url: http://foxtrot.theclarkhome.com:9090
        publicUrl: http://foxtrot.theclarkhome.com:9090

    - name: idrive
      provider: aws
      bucket: velero
      credential:
        name: idrivee2-s3-conf
        key: cloud
      config:
        region: London
        s3ForcePathStyle: true
        s3Url: https://j5o6.ldn.idrivee2-27.com
        publicUrl: https://j5o6.ldn.idrivee2-27.com
        # Disable checksumAlgorithm to avoid issues with Minio
        # https://github.com/vmware-tanzu/velero-plugin-for-aws/pull/197
        checksumAlgorithm: ""

  # volumeSnapshotLocation:
  #   - name: minio
  #     provider: aws
  #     default: true
  #     config:
  #       region: Northallerton
  #   - name: default
  #     provider: aws
  #     config:
  #       region: Northallerton
  #   - name: rustfs
  #     provider: aws
  #     config:
  #       region: rustfs-Northallerton
  #   - name: idrive
  #     provider: aws
  #     config:
  #       region: London

  extraArgs:
    - "--backup-repository-configmap=velero-backup-repository-config"

configMaps:
  backup-repository-config:
    data:
      "kopia": |
        {
          "cacheLimitMB": 2048,
          "enableCompression": true
        }

initContainers:
  - name: velero-plugin-for-aws
    image: velero/velero-plugin-for-aws:v1.13.1@sha256:472d0e486d5d5c23c782b1b123530c7df8645784523ec36ca661a326d47885ff
    volumeMounts:
      - mountPath: /target
        name: plugins

resources:
  requests:
    cpu: 22m
    memory: 549M
  limits:
    # cpu: 997m
    memory: 1066M

deployNodeAgent: true

nodeAgent:
  resources:
    requests:
      cpu: 350m
      memory: 600M
    limits:
      # cpu: 90m
      memory: 2G

schedules:
  # idrive storage
  daily-idrive:
    disabled: false
    schedule: "@daily"
    template:
      ttl: "168h"
      storageLocation: idrive
      # volumeSnapshotLocations: &idrivesnap []  # [idrive]
  weekly-idrive:
    disabled: false
    schedule: "@weekly"
    template:
      ttl: "672h"
      storageLocation: idrive
      # volumeSnapshotLocations: *idrivesnap
  monthly-idrive:
    disabled: false
    schedule: "@monthly"
    template:
      ttl: "2190h"
      storageLocation: idrive
      # volumeSnapshotLocations: *idrivesnap
  # default storage
  hourly-default:
    disabled: false
    schedule: "@hourly"
    template:
      ttl: "24h"
  daily-default:
    disabled: false
    schedule: "@daily"
    template:
      ttl: "168h"
  weekly-default:
    disabled: false
    schedule: "@weekly"
    template:
      ttl: "672h"
  monthly-default:
    disabled: false
    schedule: "@monthly"
    template:
      ttl: "2190h"

metrics:
  enabled: true
  scrapeInterval: 30s
  scrapeTimeout: 10s

  # service metdata if metrics are enabled
  service:
    annotations: {}
    labels: {}

  # Pod annotations for Prometheus
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8085"
    prometheus.io/path: "/metrics"

  serviceMonitor:
    autodetect: false
    enabled: true
    annotations: {}
    additionalLabels: {}

  nodeAgentPodMonitor:
    autodetect: false
    enabled: true
    annotations: {}
    additionalLabels: {}

  prometheusRule:
    autodetect: false
    enabled: true
    additionalLabels:
      release: kube-prometheus-stack
    spec:
      - alert: VeleroLastBackupFailed
        annotations:
          # yamllint disable-line rule:line-length
          message: Velero backup {{ $labels.schedule }} {{ $labels.namespace }} failed last backups
        expr: velero_backup_last_status{schedule!=""} != 1
        for: 15m
        labels:
          severity: warning

      - alert: VeleroBackupItemsFailed
        annotations:
          # yamllint disable-line rule:line-length
          message: Velero backup {{ $labels.schedule }} {{ $labels.namespace }} has {{ $value }} failed items
        expr: velero_backup_items_errors{schedule!=""} != 0
        for: 15m
        labels:
          severity: warning
