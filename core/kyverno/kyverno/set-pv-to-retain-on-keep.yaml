---
resources:
  - apiVersion: kyverno.io/v1
    kind: ClusterPolicy
    metadata:
      name: set-pv-to-retain-on-keep
      annotations:
        policies.kyverno.io/title: Set PV to Retain if helm keep
        policies.kyverno.io/category: Other
        policies.kyverno.io/severity: medium
        policies.kyverno.io/subject: Namespace
        kyverno.io/kyverno-version: 1.7.0
        policies.kyverno.io/minversion: 1.7.0
        kyverno.io/kubernetes-version: "1.23"
        policies.kyverno.io/description: >-
          Add label to PV if PVC is set to keep by hlem
    spec:
      mutateExistingOnPolicyUpdate: true
      rules:
        - name: add-retain-to-pv
          match:
            all:
              - resources:
                  kinds:
                    - PersistentVolumeClaim
                  annotations:
                    helm.sh/resource-policy: "keep"
                  operations:
                    - CREATE
                    - UPDATE
          mutate:
            targets:
              - apiVersion: v1
                kind: PersistentVolume
                preconditions:
                  all:
                    - key: "{{target.metadata.name}}"
                      operator: Equals
                      value: "{{request.object.spec.volumeName}}"

            patchStrategicMerge:
              spec:
                persistentVolumeReclaimPolicy: "Retain"
