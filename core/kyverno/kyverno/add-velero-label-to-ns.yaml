---
resources:
  - apiVersion: kyverno.io/v1
    kind: ClusterPolicy
    metadata:
      name: add-velero-label-to-ns.yaml
      annotations:
        policies.kyverno.io/title: Label Velero backup PVC
        policies.kyverno.io/category: Other
        policies.kyverno.io/severity: medium
        policies.kyverno.io/subject: Namespace
        kyverno.io/kyverno-version: 1.7.0
        policies.kyverno.io/minversion: 1.7.0
        kyverno.io/kubernetes-version: "1.23"
        policies.kyverno.io/description: >-
          Add label to ensure velero will backup pvc in specified namespaces
    spec:
      mutateExistingOnPolicyUpdate: true
      rules:
        - name: add-velero-label-to-ns.yaml
          match:
            any:
              - resources:
                  kinds:
                    - Namespace
          mutate:
            targets:
              - apiVersion: v1
                kind: Namespace
                preconditions:
                  any:
                    - key: "{{target.metadata.name}}"
                      operator: AnyIn
                      value:
                        - default
                        - home-assistant
                        - media
                        - monitoring
                        - vpn

            patchStrategicMerge:
              metadata:
                labels:
                  velero-backup-pvc: "true"
