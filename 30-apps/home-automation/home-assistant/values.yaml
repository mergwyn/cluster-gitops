---

# hostname to use for ingress
global:
  host: hass

defaultPodOptions:
  automountServiceAccountToken: false
  securityContext:
    runAsUser: 0
    runAsGroup: 0
    fsGroup: 0

controllers:
  home-assistant:
    annotations:
      secret.reloader.stakater.com/reload: <-
        {{.Release.Name}}-secret,
        {{.Release.Name}}-github,
        {{.Release.Name}}-prometheus

    pod:
      annotations:
        k8s.v1.cni.cncf.io/networks: |
          [{
            "name":"macvlan-static",
            "namespace": "network",
            "ips": ["10.58.0.210"]
          }]
#        pre.hook.backup.velero.io/container: sqlite-tools
#        pre.hook.backup.velero.io/command: |
#          /bin/sh -c '
#          set -e
#          echo "[velero] pre-backup sqlite WAL checkpoint"
#          command -v sqlite3 >/dev/null
#          sqlite3 /config/home-assistant_v2.db "PRAGMA wal_checkpoint(TRUNCATE);"
#          sync
#          '
#        post.hook.restore.velero.io/container: sqlite-tools
#        post.hook.restore.velero.io/command: |
#          /bin/sh -c '
#          set -e
#          echo "[velero] post-restore sqlite integrity check"
#          DB=/config/home-assistant_v2.db
#
#          if [ ! -f "$DB" ]; then
#            echo "HA DB missing after restore — refusing to start"
#            exit 1
#          fi
#
#          if ! sqlite3 "$DB" "PRAGMA integrity_check;" | grep -q "^ok$"; then
#            echo "HA DB integrity check FAILED — refusing to start"
#            exit 1
#          fi
#
#          echo "HA DB integrity check OK"
#          '

    initContainers:
      kopiaignore:
        image:
          repository: docker.io/library/alpine
          tag: 3.23@sha256:25109184c71bdad752c8312a8623239686a9a2071e8825f20acb8f2198c3f659
        command: ["/bin/sh", "-c"]
        args:
          - |-
            tee /config/.kopiaignore <<!
            /.code-server/logs
            /.git
            /.venv
            /backups
            !
        securityContext:
          runAsUser: 0
      github-setup:
        # Connect to config repo
        image:
          repository: docker.io/library/ubuntu
          tag: 26.04@sha256:4095ef613201918336b5d7d00be15d8b09c72ddb77c80bca249c255887a64d87
        command: ["/bin/sh", "-c"]
        args:
          - |-
            set -x
            cd /config
            # Need to initialise repository?
            if [ ! -d .git ] ; then
              # This container will never have git installed
              apt update && apt install -y git
              # Prepare to clone
              mkdir temp-dir
              git clone https://github.com/mergwyn/home-assistant-config temp-dir
              mv temp-dir/.git .
              rm -rf temp-dir
              # Finally get files
              git checkout .
            fi
        securityContext:
          runAsUser: 0

    containers:
      app:
        image:
          repository: ghcr.io/home-assistant/home-assistant
          # yamllint disable-line rule:line-length
          tag: "2026.2.1@sha256:17441c45ba14560b4ef727ee06aac4d605cf0dc0625fc4f2e043cb2551d72749"
        env:
          TZ: Europe/London
          VENV_FOLDER: /venv
        envFrom:
          - secretRef:
              name: "{{.Release.Name}}-github"
        command:
          - /bin/sh
          - -c
        args:
          - |
            set -e
            if ! command -v sqlite3 >/dev/null; then
              echo "[guardrail] Installing sqlite3"
              apk add --no-cache sqlite
            fi

            DB=/config/home-assistant_v2.db

            echo "[guardrail] Checking Home Assistant SQLite DB..."

            if [ ! -f "$DB" ]; then
              echo "[guardrail] ERROR: DB missing — refusing to start"
              exit 1
            fi

            if ! sqlite3 "$DB" "PRAGMA integrity_check;" | grep -q "^ok$"; then
              echo "[guardrail] ERROR: DB corrupt — refusing to start"
              exit 1
            fi

            echo "[guardrail] DB OK — starting Home Assistant"

            exec /init
        resources:
          requests:
            cpu: 47m
            memory: 1239M
          limits:
            memory: 2G

      sqlite-tools:
        image:
          repository: docker.io/library/alpine
          tag: 3.23@sha256:25109184c71bdad752c8312a8623239686a9a2071e8825f20acb8f2198c3f659
        command: ["/bin/sh", "-c"]
        args:
          - apk add --no-cache sqlite && sleep infinity
        securityContext:
          runAsUser: 0

      code-server:
        image:
          repository: ghcr.io/coder/code-server
          # yamllint disable-line rule:line-length
          tag: 4.108.1@sha256:867b9a9dedd68f1b46e308cad9525e419db7b0ce0c83831f6a350f37ee7ff6fd
        args:
          - --auth=none
          - --disable-telemetry
          - --disable-update-check
          - --user-data-dir=/config/.code-server
          - --extensions-dir=/config/.code-server
          # - --install-extension=trunk.io
          - --port=12321
          - /config
        env:
          TZ: Europe/London
          HASS_SERVER: http://localhost:8123
          # yamllint disable-line rule:line-length
          EXTENSIONS_GALLERY: '{ "serviceUrl": "https://marketplace.visualstudio.com/_apis/public/gallery", "itemUrl": "https://marketplace.vis  ualstudio.com/items" }'
        envFrom:
          - secretRef:
              name: "{{.Release.Name}}-github"
        resources:
          requests:
            cpu: 10m
            memory: 978M
          limits:
            memory: 5G

service:
  app:
    forceRename: "{{.Release.Name}}"
    ports:
      http:
        port: &http-port 8123
  code-server:
    ports:
      http:
        port: &code-server-port 12321

serviceMonitor:
  app:
    enabled: true
    serviceName: "{{.Release.Name}}"
    endpoints:
      - port: http
        scheme: http
        interval: 1m
        scrapeTimeout: 30s
        path: /api/prometheus
        bearerTokenSecret:
          name: home-assistant-prometheus
          key: token

persistence:
  config:
    type: persistentVolumeClaim
    storageClass: openebs-zfspv
    accessMode: ReadWriteOnce
    retain: true
    size: 10Gi
    globalMounts:
      - path: /config
  backups:
    enabled: true
    type: nfs
    server: 10.58.0.12
    path: /srv/backup/home-assistant
    globalMounts:
      - path: /config/backups
  cache:
    type: persistentVolumeClaim
    storageClass: openebs-zfspv
    accessMode: ReadWriteOnce
    retain: true
    size: 1Gi
    advancedMounts:
      home-assistant:
        app:
          - path: /config/.venv
            subPath: hass-venv
  secrets:
    type: secret
    name: "{{.Release.Name}}-secret"
    advancedMounts:
      home-assistant:
        app:
          - path: /config/secrets.yaml
            subPath: secrets.yaml
            readOnly: true
  tmpfs:
    type: emptyDir
    advancedMounts:
      home-assistant:
        app:
          - path: /tmp
            subPath: hass-tmp
        code-server:
          - path: /tmp
            subPath: code-server-tmp
          - path: /nonexistent
            subPath: nonexistent

rawResources:
  rules:
    kind: PrometheusRule
    apiVersion: monitoring.coreos.com/v1
    spec:
      spec:
        groups:
          - name: home-assistant
            rules:
              - alert: HomeAssistantAbsent
                annotations:
                  description: |
                    Home Assistant has disappeared from
                    Prometheus service discovery.
                  summary: Home Assistant is down.
                expr: |
                  absent(up{job=~".*home-assistant.*"} == 1)
                for: 5m
                labels:
                  severity: critical
              - alert: HomeAssistantGuardrailTriggered
                expr: |
                  kube_pod_container_status_waiting_reason{
                    namespace="home-assistant",
                    pod=~"home-assistant-.*",
                    container="app",
                    reason="CrashLoopBackOff"
                  } > 0
                for: 5m
                labels:
                  severity: critical
                annotations:
                  summary: Home Assistant refused to start (DB guardrail)
                  description: |
                    Home Assistant is CrashLooping.
                    This usually indicates a failed SQLite integrity check
                    after restore or storage corruption.

route:
  app:
    hostnames:
      - "{{.Values.global.host}}.{{.Values.global.domain}}"
    parentRefs:
      - name: traefik-internal
        namespace: network
    rules:
      - backendRefs:
          - identifier: app
            port: *http-port
  code-server:
    hostnames:
      - "{{.Values.global.host}}.{{.Values.global.domain}}"
    parentRefs:
      - name: traefik-internal
        namespace: network
    rules:
      - backendRefs:
          - identifier: code-server
            port: *code-server-port
        matches:
          - path:
              type: PathPrefix
              value: /code/
        filters:
          - type: URLRewrite
            urlRewrite:
              path:
                replacePrefixMatch: /
                type: ReplacePrefixMatch

ingress:
  external:
    enabled: true
    className: cloudflare-tunnel
    annotations:
      cloudflare-tunnel-ingress-controller.strrl.dev/backend-protocol: http
    hosts:
      - host: "{{.Values.global.host}}.{{.Values.global.domain}}"
        paths:
          - path: /
            pathType: Prefix
            service:
              identifier: app
              port: http
