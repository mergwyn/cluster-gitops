---
name: ApplicationSet Safety

on:
  pull_request:
    paths:
      - argocd/appsets/**
      - "**/app.yaml"

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install yq
        uses: mikefarah/yq@065b200af9851db0d5132f50bc10b1406ea5c0a8 # v4.50.1

      - name: Validate required fields in app.yaml
        run: |
          set -e
          echo "ğŸ” Validating required keys in app.yaml files"
          find . -name app.yaml -print0 | while IFS= read -r -d '' f; do
            yq e ' .wave and
                   .namespace' "$f" > /dev/null \
              || { echo "âŒ Missing required field in $f"; exit 1; }
          done
