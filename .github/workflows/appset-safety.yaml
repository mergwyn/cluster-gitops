---
name: ApplicationSet Safety

on:
  pull_request:
    paths:
      - argocd/appsets/**
      - "**/app.yaml"

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Install yq
        uses: mikefarah/yq@v4.44.1

      - name: Validate required fields in app.yaml
        run: |
          set -e
          echo "üîç Validating required keys in app.yaml files"
          find . -name app.yaml -print0 | while IFS= read -r -d '' f; do
            yq e '
              .name
              and .namespace
              and .wave
              and .path
            ' "$f" > /dev/null \
              || { echo "‚ùå Missing required field in $f"; exit 1; }
          done

      - name: Validate app.yaml path exists
        run: |
          set -e
          echo "üìÇ Validating path references"
          find . -name app.yaml -print0 | while IFS= read -r -d '' f; do
            PATH_VAL=$(yq e '.path' "$f")
            if [[ ! -d "$PATH_VAL" ]]; then
              echo "‚ùå Path does not exist: $PATH_VAL (from $f)"
              exit 1
            fi
          done

      - name: Detect duplicate app names
        run: |
          set -e
          echo "üîÅ Checking for duplicate app names"
          DUPES=$(
            find . -name app.yaml -exec yq e '.name' {} \; \
              | sort | uniq -d
          )
          if [[ -n "$DUPES" ]]; then
            echo "‚ùå Duplicate application names found:"

